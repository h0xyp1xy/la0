# Nginx site for la0 Django app
# Install: sudo cp deploy/la0-nginx.conf /etc/nginx/sites-available/la0
#         sudo ln -sf /etc/nginx/sites-available/la0 /etc/nginx/sites-enabled/
# Optional: add to http {} for rate limiting: include /path/to/la0/deploy/la0-nginx-ratelimit-zone.conf;
#         And uncomment limit_req below.
#         sudo nginx -t && sudo systemctl reload nginx
# Add www-data to la0app group: sudo usermod -aG la0app www-data
# HTTPS: certbot --nginx -d levushkin.art -d www.levushkin.art
# server_tokens off: add to http {} in nginx.conf to hide version

upstream la0_gunicorn {
    server unix:/run/la0/gunicorn.sock fail_timeout=0;
}

server {
    listen 80;
    server_name levushkin.art www.levushkin.art;

    # DoS mitigation
    client_max_body_size 4M;
    client_body_buffer_size 16k;
    # limit_req zone=la0_limit burst=20 nodelay;  # Uncomment after including la0-nginx-ratelimit-zone.conf in http {}

    # Security headers
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()" always;

    # Static: fixed path, no path traversal (alias does not resolve ..)
    root /home/ktt/Documents/la0/backend/staticfiles;
    location /static/ {
        alias /home/ktt/Documents/la0/backend/staticfiles/;
        # Disable listing, no script execution
        autoindex off;
    }

    location / {
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        proxy_buffering off;
        proxy_read_timeout 30s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_pass http://la0_gunicorn;
    }
}

# HTTPS server block â€” certbot will modify this
# Recommended SSL settings (add inside server { listen 443 ssl; ... }):
#   ssl_protocols TLSv1.2 TLSv1.3;
#   ssl_prefer_server_ciphers on;
#   ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
#   add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
